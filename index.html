<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¸ MyGO!!!!! TCG v2 - å®Œæ•´æˆ°é¬¥ç³»çµ±æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
            border: 2px solid #4a5a6a;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            border-radius: 15px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .game-status {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-info, .pitcher-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .player-info {
            border-left: 4px solid #27ae60;
        }

        .pitcher-info {
            border-left: 4px solid #e74c3c;
        }

        .combat-log {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .hp-bar {
            width: 100%;
            height: 20px;
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            transition: width 0.5s ease;
        }

        .battle-field {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin: 20px 0;
            min-height: 200px;
        }

        .zone {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed #4a5a6a;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .zone.strike-zone {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .zone.support-zone {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .zone.spell-zone {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }

        .zone.drag-over {
            border-style: solid;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .zone-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .zone-card {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .zone-card.batter { border-color: #e74c3c; }
        .zone-card.support { border-color: #3498db; }
        .zone-card.spell { border-color: #9b59b6; }

        .card-stats {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .hand {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow-x: auto;
            min-height: 200px;
            border: 2px solid #4a5a6a;
        }

        .card {
            min-width: 140px;
            width: 140px;
            height: 200px;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 12px;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-15px) scale(1.08);
            box-shadow: 0 20px 40px rgba(52, 152, 219, 0.4);
            z-index: 100;
        }

        .card.dragging {
            opacity: 0.7;
            transform: rotate(8deg) scale(1.1);
            z-index: 1000;
        }

        .card.batter { border-color: #e74c3c; }
        .card.support { border-color: #3498db; }
        .card.spell { border-color: #9b59b6; }

        .card.rare {
            background: linear-gradient(145deg, #8e44ad, #9b59b6);
            box-shadow: 0 0 25px rgba(155, 89, 182, 0.4);
        }

        .card.legendary {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.5);
            animation: legendary-glow 2s infinite alternate;
        }

        @keyframes legendary-glow {
            0% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
            100% { box-shadow: 0 0 40px rgba(243, 156, 18, 0.8); }
        }

        .card-name {
            font-weight: bold;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .card-type {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .card-stats {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            text-align: center;
            margin: 8px 0;
            line-height: 1.3;
        }

        .card-description {
            font-size: 0.75rem;
            line-height: 1.3;
            opacity: 0.9;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(145deg, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.attack {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .btn.attack:hover:not(:disabled) {
            background: linear-gradient(145deg, #c0392b, #e74c3c);
        }

        .status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .effect {
            background: rgba(155, 89, 182, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .damage-number {
            position: fixed;
            font-size: 2rem;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
            animation: damage-float 2s ease-out forwards;
        }

        .damage-number.damage {
            color: #e74c3c;
            text-shadow: 0 0 10px #e74c3c;
        }

        .damage-number.heal {
            color: #27ae60;
            text-shadow: 0 0 10px #27ae60;
        }

        @keyframes damage-float {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .game-over-content {
            text-align: center;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #f39c12;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 2px 5px;
            border-left: 3px solid #3498db;
            padding-left: 8px;
            font-size: 0.85rem;
        }

        .log-entry.damage { border-color: #e74c3c; color: #e74c3c; }
        .log-entry.heal { border-color: #27ae60; color: #27ae60; }
        .log-entry.effect { border-color: #9b59b6; color: #9b59b6; }
        .log-entry.system { border-color: #f39c12; color: #f39c12; }

        @media (max-width: 768px) {
            .battle-field {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .game-status {
                grid-template-columns: 1fr;
            }
            
            .hand {
                padding: 10px;
            }
            
            .card {
                min-width: 120px;
                width: 120px;
                height: 170px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ğŸ¸ MyGO!!!!! TCG v2</h1>
            <p>å®Œæ•´æˆ°é¬¥ç³»çµ±æ¼”ç¤º - æŠ€è¡“è¦æ ¼æ›¸ç²¾ç¢ºå¯¦ç¾</p>
        </div>

        <div class="game-status">
            <div class="player-info">
                <h3>ğŸ¸ ç©å®¶</h3>
                <div class="hp-bar">
                    <div class="hp-fill" id="player-hp-fill" style="width: 100%"></div>
                </div>
                <div id="player-hp">100 / 100</div>
                <div class="status-effects" id="player-buffs"></div>
            </div>

            <div class="combat-log" id="combat-log">
                <div class="log-entry system">ğŸš€ éŠæˆ²ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
                <div class="log-entry">ğŸ“‹ æŠ€è¡“è¦æ ¼æ›¸æˆ°é¬¥å…¬å¼è¼‰å…¥</div>
                <div class="log-entry">ğŸ¯ ç­‰å¾…ç©å®¶æ“ä½œ...</div>
            </div>

            <div class="pitcher-info">
                <h3>âš¾ æŠ•æ‰‹</h3>
                <div class="hp-bar">
                    <div class="hp-fill" id="pitcher-hp-fill" style="width: 100%"></div>
                </div>
                <div id="pitcher-hp">150 / 150</div>
                <div id="pitcher-attack">æ”»æ“ŠåŠ›: 30</div>
                <div class="status-effects" id="pitcher-debuffs"></div>
            </div>
        </div>

        <div class="battle-field">
            <div class="zone support-zone" id="support-zone" data-zone="support_zone">
                <div class="zone-title">ğŸ›¡ï¸ è¼”åŠ©å€</div>
                <div class="zone-description">æ‹–æ‹½è¼”åŠ©å¡æˆ–æ‰“è€…å¡åˆ°é€™è£¡</div>
            </div>

            <div class="zone strike-zone" id="strike-zone" data-zone="strike_zone">
                <div class="zone-title">âš”ï¸ æ‰“æ“Šå€</div>
                <div class="zone-description">æ‹–æ‹½æ‰“è€…å¡åˆ°é€™è£¡é€²è¡Œæ”»æ“Š</div>
            </div>

            <div class="zone spell-zone" id="spell-zone" data-zone="spell_zone">
                <div class="zone-title">âœ¨ æ³•è¡“å€</div>
                <div class="zone-description">æ‹–æ‹½æ³•è¡“å¡åˆ°é€™è£¡</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn attack" id="attack-btn" disabled>âš”ï¸ æ”»æ“Š</button>
            <button class="btn" id="new-turn-btn">ğŸ”„ æ–°å›åˆ</button>
            <button class="btn" id="reset-btn">ğŸ†• é‡æ–°é–‹å§‹</button>
        </div>

        <div class="hand" id="hand">
            <!-- æ‰‹ç‰Œæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <script type="module">
        // ===== ğŸ® å®Œæ•´éŠæˆ²å¯¦ç¾ =====
        
        // ç°¡åŒ–çš„äº‹ä»¶ç³»çµ±
        class EventBus {
            constructor() {
                this.listeners = new Map();
            }
            
            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }
            
            emit(event, data) {
                const callbacks = this.listeners.get(event) || [];
                callbacks.forEach(callback => callback(data));
            }
        }

        // éŠæˆ²å¸¸æ•¸
        const GAME_BALANCE = {
            PLAYER_INITIAL_HP: 100,
            PITCHER_INITIAL_HP: 150,
            HAND_SIZE_LIMIT: 7,
            PITCHER_BASE_FATIGUE_RATE: 0.05
        };

        // å®Œæ•´çš„æˆ°é¬¥ç³»çµ±
        class CombatSystem {
            constructor(eventBus) {
                this.eventBus = eventBus;
            }

            calculateDamage(gameState) {
                console.log('âš”ï¸ é–‹å§‹å‚·å®³è¨ˆç®—...');
                
                // Step 1: åˆå§‹åŒ–åŸºç¤å€¼
                let totalAttack = 0;
                let totalCrit = 0;
                
                const strikeCard = gameState.player.strike_zone[0];
                const supportCard = gameState.player.support_zone[0];
                
                if (strikeCard) {
                    totalAttack += strikeCard.stats.attack;
                    totalCrit += strikeCard.stats.crit;
                    console.log(`ğŸ—¡ï¸ æ‰“æ“Šå€: ${strikeCard.name} - æ”»æ“Š:${strikeCard.stats.attack} æš´æ“Š:${strikeCard.stats.crit}`);
                }
                
                if (supportCard) {
                    totalAttack += supportCard.stats.attack;
                    totalCrit += supportCard.stats.crit;
                    console.log(`ğŸ›¡ï¸ è¼”åŠ©å€: ${supportCard.name} - æ”»æ“Š:${supportCard.stats.attack} æš´æ“Š:${supportCard.stats.crit}`);
                }

                // Step 2: æ‡‰ç”¨æ•ˆæœèˆ‡Buff
                const modifiedStats = this.applyEffectsAndBuffs(gameState, totalAttack, totalCrit, strikeCard, supportCard);
                totalAttack = modifiedStats.attack;
                totalCrit = modifiedStats.crit;

                // Step 3: æ ¸å¿ƒå…¬å¼
                let finalDamage = totalAttack * (1 + totalCrit / 100);
                console.log(`ğŸ§® æ ¸å¿ƒå…¬å¼: ${totalAttack} * (1 + ${totalCrit}/100) = ${finalDamage}`);

                // Step 4: å±¬æ€§å…‹åˆ¶
                const playerAttr = this.getPlayerMainAttribute(gameState);
                const pitcherAttr = gameState.pitcher.attribute;
                
                if (this.isStrongAgainst(playerAttr, pitcherAttr)) {
                    finalDamage *= 1.2;
                    console.log(`âš¡ å±¬æ€§å…‹åˆ¶: ${playerAttr} å…‹åˆ¶ ${pitcherAttr}, å‚·å®³ x1.2`);
                }

                // Step 5: å››æ¨äº”å…¥å–æ•´
                finalDamage = Math.round(finalDamage);
                console.log(`ğŸ¯ æœ€çµ‚å‚·å®³: ${finalDamage}`);

                return {
                    finalDamage,
                    breakdown: {
                        baseAttack: totalAttack,
                        baseCrit: totalCrit,
                        critMultiplier: (1 + totalCrit / 100),
                        attributeBonus: this.isStrongAgainst(playerAttr, pitcherAttr) ? 1.2 : 1.0
                    }
                };
            }

            applyEffectsAndBuffs(gameState, baseAttack, baseCrit, strikeCard, supportCard) {
                let totalAttack = baseAttack;
                let totalCrit = baseCrit;

                // æ‡‰ç”¨å¡ç‰Œçš„è‡¨æ™‚åŠ æˆ
                if (strikeCard?.tempBonus) {
                    totalAttack += strikeCard.tempBonus.attack || 0;
                    totalCrit += strikeCard.tempBonus.crit || 0;
                }

                if (supportCard?.tempBonus) {
                    totalAttack += supportCard.tempBonus.attack || 0;
                    totalCrit += supportCard.tempBonus.crit || 0;
                }

                // æ‡‰ç”¨å›åˆBuff
                gameState.turnBuffs?.forEach(buff => {
                    if (buff.type === 'human_batter_attack_boost' && strikeCard?.attribute === 'human') {
                        totalAttack += buff.value;
                        console.log(`ğŸ’ ${buff.source}: äººå±¬æ‰“è€…æ”»æ“ŠåŠ› +${buff.value}`);
                    }
                });

                return { attack: totalAttack, crit: totalCrit };
            }

            isStrongAgainst(playerAttr, enemyAttr) {
                const advantages = {
                    'human': ['yin'],
                    'yin': ['yang'], 
                    'yang': ['heaven'],
                    'heaven': ['earth'],
                    'earth': ['human']
                };
                return advantages[playerAttr]?.includes(enemyAttr) || false;
            }

            getPlayerMainAttribute(gameState) {
                if (gameState.player.strike_zone[0]) {
                    return gameState.player.strike_zone[0].attribute;
                }
                if (gameState.player.support_zone[0]) {
                    return gameState.player.support_zone[0].attribute;
                }
                return 'human';
            }

            async executeCombat(gameState) {
                console.log('ğŸ® é–‹å§‹æˆ°é¬¥éšæ®µ...');
                
                if (!gameState.player.strike_zone[0]) {
                    return { success: false, reason: 'æ‰“æ“Šå€æ²’æœ‰å¡ç‰Œ' };
                }

                // è§¸ç™¼å¡ç‰Œæ•ˆæœ
                const strikeCard = gameState.player.strike_zone[0];
                if (strikeCard.effects?.on_strike) {
                    await strikeCard.effects.on_strike.call(strikeCard, gameState);
                }

                const supportCard = gameState.player.support_zone[0];
                if (supportCard?.effects?.on_support) {
                    await supportCard.effects.on_support.call(supportCard, gameState);
                }

                // è¨ˆç®—å‚·å®³
                const damageResult = this.calculateDamage(gameState);
                
                // å°æŠ•æ‰‹é€ æˆå‚·å®³
                gameState.pitcher.current_hp -= damageResult.finalDamage;
                gameState.pitcher.current_hp = Math.max(0, gameState.pitcher.current_hp);
                
                this.eventBus.emit('damage_dealt', {
                    damage: damageResult.finalDamage,
                    breakdown: damageResult.breakdown,
                    pitcherHP: gameState.pitcher.current_hp
                });

                // æŠ•æ‰‹åæ“Š
                const pitcherDamage = this.calculatePitcherDamage(gameState);
                gameState.player.current_hp -= pitcherDamage;
                gameState.player.current_hp = Math.max(0, gameState.player.current_hp);

                this.eventBus.emit('pitcher_attack', {
                    damage: pitcherDamage,
                    playerHP: gameState.player.current_hp
                });

                return {
                    success: true,
                    playerDamageDealt: damageResult.finalDamage,
                    playerDamageReceived: pitcherDamage
                };
            }

            calculatePitcherDamage(gameState) {
                let damage = gameState.pitcher.current_attack;
                
                if (gameState.pitcher.tempDebuff?.attack) {
                    damage += gameState.pitcher.tempDebuff.attack;
                }

                return Math.max(0, Math.round(damage));
            }

            applyPitcherFatigue(gameState) {
                gameState.pitcher.current_attack *= (1 - GAME_BALANCE.PITCHER_BASE_FATIGUE_RATE);
                gameState.pitcher.current_attack = Math.round(gameState.pitcher.current_attack);
                
                this.eventBus.emit('pitcher_fatigue', {
                    newAttack: gameState.pitcher.current_attack
                });
            }
        }

        // éŠæˆ²æ§åˆ¶å™¨
        class GameController {
            constructor() {
                this.eventBus = new EventBus();
                this.combatSystem = new CombatSystem(this.eventBus);
                this.gameState = this.createInitialGameState();
                this.setupEventListeners();
                
                console.log('ğŸ® éŠæˆ²æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
            }

            createInitialGameState() {
                return {
                    player: {
                        current_hp: GAME_BALANCE.PLAYER_INITIAL_HP,
                        max_hp: GAME_BALANCE.PLAYER_INITIAL_HP,
                        hand: [],
                        strike_zone: [],
                        support_zone: [],
                        spell_zone: [],
                        active_buffs: []
                    },
                    pitcher: {
                        current_hp: GAME_BALANCE.PITCHER_INITIAL_HP,
                        max_hp: GAME_BALANCE.PITCHER_INITIAL_HP,
                        base_attack: 30,
                        current_attack: 30,
                        attribute: "heaven",
                        active_debuffs: []
                    },
                    turnBuffs: []
                };
            }

            setupEventListeners() {
                this.eventBus.on('damage_dealt', (data) => {
                    this.showDamageNumber(data.damage, 'damage');
                    this.addLogEntry(`ğŸ’¥ å°æŠ•æ‰‹é€ æˆ ${data.damage} é»å‚·å®³`, 'damage');
                    this.updateUI();
                });

                this.eventBus.on('pitcher_attack', (data) => {
                    this.showDamageNumber(data.damage, 'heal', true);
                    this.addLogEntry(`âš”ï¸ æŠ•æ‰‹åæ“Šé€ æˆ ${data.damage} é»å‚·å®³`, 'damage');
                    this.updateUI();
                });

                this.eventBus.on('pitcher_fatigue', (data) => {
                    this.addLogEntry(`ğŸ˜´ æŠ•æ‰‹ç–²å‹ï¼Œæ”»æ“ŠåŠ›é™è‡³ ${data.newAttack}`, 'system');
                    this.updateUI();
                });
            }

            async playCard(cardIndex, targetZone) {
                const card = this.gameState.player.hand[cardIndex];
                if (!card) return { success: false, reason: 'ç„¡æ•ˆçš„å¡ç‰Œ' };

                if (this.gameState.player[targetZone].length > 0) {
                    return { success: false, reason: 'å€åŸŸå·²æ»¿' };
                }

                if (!this.isValidPlacement(card, targetZone)) {
                    return { success: false, reason: 'å¡ç‰Œé¡å‹ä¸åŒ¹é…' };
                }

                // ç§»å‹•å¡ç‰Œ
                this.gameState.player.hand.splice(cardIndex, 1);
                this.gameState.player[targetZone].push(card);

                // è§¸ç™¼æ‰“å‡ºæ•ˆæœ
                if (card.effects?.on_play) {
                    const result = await card.effects.on_play.call(card, this.gameState);
                    if (result.success) {
                        this.addLogEntry(`âœ¨ ${card.name}: ${result.description}`, 'effect');
                    }
                }

                this.addLogEntry(`ğŸ´ ${card.name} æ”¾ç½®åˆ°${targetZone === 'strike_zone' ? 'æ‰“æ“Šå€' : targetZone === 'support_zone' ? 'è¼”åŠ©å€' : 'æ³•è¡“å€'}`, 'system');
                this.updateUI();

                return { success: true };
            }

            async executeAttack() {
                const result = await this.combatSystem.executeCombat(this.gameState);
                
                if (result.success) {
                    // æ‡‰ç”¨æŠ•æ‰‹ç–²å‹
                    this.combatSystem.applyPitcherFatigue(this.gameState);
                    
                    // æª¢æŸ¥å‹è² 
                    if (this.gameState.player.current_hp <= 0) {
                        this.showGameOver('æŠ•æ‰‹ç²å‹ï¼', 'ç©å®¶è¡€é‡æ­¸é›¶');
                        return;
                    }
                    
                    if (this.gameState.pitcher.current_hp <= 0) {
                        this.showGameOver('ç©å®¶ç²å‹ï¼', 'æŠ•æ‰‹è¡€é‡æ­¸é›¶');
                        return;
                    }
                    
                    // æ¸…ç†å ´ä¸Šå¡ç‰Œ
                    this.clearField();
                }

                return result;
            }

            clearField() {
                const zones = ['strike_zone', 'support_zone', 'spell_zone'];
                zones.forEach(zone => {
                    this.gameState.player[zone] = [];
                });
                
                // æ¸…ç†è‡¨æ™‚æ•ˆæœ
                this.gameState.turnBuffs = [];
                
                this.updateUI();
            }

            isValidPlacement(card, targetZone) {
                const validPlacements = {
                    'strike_zone': ['batter'],
                    'support_zone': ['support', 'batter'],
                    'spell_zone': ['spell']
                };
                return validPlacements[targetZone]?.includes(card.type) || false;
            }

            createTestDeck() {
                return [
                    {
                        id: 'president',
                        name: 'ç¸½çµ±',
                        type: 'batter',
                        attribute: 'human',
                        rarity: 'common',
                        stats: { attack: 15, crit: 35 },
                        description: 'æ‰“æ“Šï¼šç‰Œçµ„è£¡æ¯æœ‰ä¸€å¼µäººå±¬æ€§å¡ï¼Œæ”»æ“ŠåŠ›+1',
                        effects: {
                            on_strike: async function(gameState) {
                                const humanCards = 5; // æ¨¡æ“¬æ•¸é‡
                                this.tempBonus = { attack: humanCards };
                                return { success: true, description: `äººå±¬æ€§å¡åŠ æˆ: æ”»æ“ŠåŠ›+${humanCards}` };
                            }
                        }
                    },
                    {
                        id: 'kindness',
                        name: 'æ…ˆæ„›',
                        type: 'support',
                        attribute: 'human',
                        rarity: 'common',
                        stats: { attack: 8, crit: 70 },
                        description: 'è¼”åŠ©ï¼šäººå±¬æ€§æ‰“è€…å¡æ”»æ“ŠåŠ›+10',
                        effects: {
                            on_support: async function(gameState) {
                                gameState.turnBuffs.push({
                                    type: 'human_batter_attack_boost',
                                    value: 10,
                                    source: 'æ…ˆæ„›'
                                });
                                return { success: true, description: 'äººå±¬æ‰“è€…æœ¬å›åˆæ”»æ“ŠåŠ›+10' };
                            }
                        }
                    },
                    {
                        id: 'hero',
                        name: 'è‹±é›„',
                        type: 'batter',
                        attribute: 'human',
                        rarity: 'common',
                        stats: { attack: 25, crit: 50 },
                        description: 'ç„¡æ•ˆæœ'
                    },
                    {
                        id: 'shadow_devour',
                        name: 'æš—å½±åå™¬',
                        type: 'batter',
                        attribute: 'yin',
                        rarity: 'common',
                        stats: { attack: 20, crit: 35 },
                        description: 'æ‰“æ“Šï¼šè‹¥æœ¬å›åˆæ²’æœ‰å…¶ä»–é™°å±¬å¡ï¼Œæ”»æ“ŠåŠ›+10ã€‚è¼”åŠ©ï¼šæŠ•æ‰‹æ”»æ“ŠåŠ›-3',
                        effects: {
                            on_strike: async function(gameState) {
                                this.tempBonus = { attack: 10 };
                                return { success: true, description: 'æš—å½±åŠ æˆ: æ”»æ“ŠåŠ›+10' };
                            },
                            on_support: async function(gameState) {
                                gameState.pitcher.tempDebuff = { attack: -3 };
                                return { success: true, description: 'æŠ•æ‰‹æ”»æ“ŠåŠ›-3' };
                            }
                        }
                    },
                    {
                        id: 'yinyang_harmony',
                        name: 'é™°é™½èª¿å’Œ',
                        type: 'batter',
                        attribute: 'yang',
                        rarity: 'rare',
                        stats: { attack: 20, crit: 25 },
                        description: 'æ‰“æ“Šï¼šè‹¥è¼”åŠ©æ ¼ç‚ºé™°å±¬æ€§ï¼Œæ”»æ“ŠåŠ›ç¿»å€'
                    }
                ];
            }

            startGame() {
                // å‰µå»ºæ¸¬è©¦æ‰‹ç‰Œ
                this.gameState.player.hand = this.createTestDeck();
                this.updateUI();
                
                this.addLogEntry('ğŸš€ éŠæˆ²é–‹å§‹ï¼æ‹–æ‹½å¡ç‰Œåˆ°å ´ä¸Šé€²è¡Œæˆ°é¬¥', 'system');
            }

            updateUI() {
                this.updatePlayerInfo();
                this.updatePitcherInfo();
                this.updateHand();
                this.updateBattleField();
                this.updateAttackButton();
            }

            updatePlayerInfo() {
                const player = this.gameState.player;
                const hpPercent = (player.current_hp / player.max_hp) * 100;
                
                document.getElementById('player-hp-fill').style.width = `${hpPercent}%`;
                document.getElementById('player-hp').textContent = `${player.current_hp} / ${player.max_hp}`;
            }

            updatePitcherInfo() {
                const pitcher = this.gameState.pitcher;
                const hpPercent = (pitcher.current_hp / pitcher.max_hp) * 100;
                
                document.getElementById('pitcher-hp-fill').style.width = `${hpPercent}%`;
                document.getElementById('pitcher-hp').textContent = `${pitcher.current_hp} / ${pitcher.max_hp}`;
                document.getElementById('pitcher-attack').textContent = `æ”»æ“ŠåŠ›: ${pitcher.current_attack}`;
            }

            updateHand() {
                const handEl = document.getElementById('hand');
                handEl.innerHTML = '';
                
                this.gameState.player.hand.forEach((card, index) => {
                    const cardEl = this.createCardElement(card, index);
                    handEl.appendChild(cardEl);
                });
            }

            updateBattleField() {
                const zones = ['strike_zone', 'support_zone', 'spell_zone'];
                
                zones.forEach(zone => {
                    const zoneEl = document.getElementById(zone.replace('_', '-'));
                    const existingCard = zoneEl.querySelector('.zone-card');
                    if (existingCard) existingCard.remove();
                    
                    const card = this.gameState.player[zone][0];
                    if (card) {
                        const cardEl = document.createElement('div');
                        cardEl.className = `zone-card ${card.type}`;
                        cardEl.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">${card.name}</div>
                            <div class="card-stats">æ”»æ“Š: ${card.stats.attack} | æš´æ“Š: ${card.stats.crit}</div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">${card.description}</div>
                        `;
                        zoneEl.appendChild(cardEl);
                    }
                });
            }

            updateAttackButton() {
                const attackBtn = document.getElementById('attack-btn');
                const hasStrikeCard = this.gameState.player.strike_zone.length > 0;
                
                attackBtn.disabled = !hasStrikeCard;
                attackBtn.textContent = hasStrikeCard ? 'âš”ï¸ æ”»æ“Š' : 'âš”ï¸ æ”»æ“Š (éœ€è¦æ‰“æ“Šå€å¡ç‰Œ)';
            }

            createCardElement(card, index) {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.type} ${card.rarity}`;
                cardEl.draggable = true;
                cardEl.dataset.index = index;
                
                cardEl.innerHTML = `
                    <div class="card-type">${card.type}</div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-stats">
                        æ”»æ“Š: ${card.stats.attack}<br>
                        æš´æ“Š: ${card.stats.crit}
                    </div>
                    <div class="card-description">${card.description}</div>
                `;

                // æ‹–æ‹½äº‹ä»¶
                cardEl.addEventListener('dragstart', (e) => {
                    cardEl.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', index);
                });

                cardEl.addEventListener('dragend', () => {
                    cardEl.classList.remove('dragging');
                });

                return cardEl;
            }

            showDamageNumber(damage, type, isPlayerDamage = false) {
                const damageEl = document.createElement('div');
                damageEl.className = `damage-number ${type}`;
                damageEl.textContent = type === 'damage' ? `-${damage}` : `+${damage}`;
                
                const rect = document.querySelector(isPlayerDamage ? '.player-info' : '.pitcher-info').getBoundingClientRect();
                damageEl.style.left = `${rect.left + rect.width / 2}px`;
                damageEl.style.top = `${rect.top}px`;
                
                document.body.appendChild(damageEl);
                
                setTimeout(() => damageEl.remove(), 2000);
            }

            addLogEntry(message, type = '') {
                const logEl = document.getElementById('combat-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logEl.appendChild(entry);
                logEl.scrollTop = logEl.scrollHeight;
                
                if (logEl.children.length > 20) {
                    logEl.removeChild(logEl.firstChild);
                }
            }

            showGameOver(title, reason) {
                const gameOverEl = document.createElement('div');
                gameOverEl.className = 'game-over';
                gameOverEl.innerHTML = `
                    <div class="game-over-content">
                        <h1 style="color: #f39c12; margin-bottom: 20px;">${title}</h1>
                        <p style="font-size: 1.2rem; margin-bottom: 30px;">${reason}</p>
                        <button class="btn" onclick="location.reload()">ğŸ†• é‡æ–°é–‹å§‹</button>
                    </div>
                `;
                document.body.appendChild(gameOverEl);
            }
        }

        // ===== ğŸš€ éŠæˆ²å•Ÿå‹• =====
        const game = new GameController();

        // è¨­ç½®æ‹–æ‹½å€åŸŸ
        document.querySelectorAll('.zone').forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', async (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                
                const cardIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const targetZone = zone.dataset.zone;
                
                const result = await game.playCard(cardIndex, targetZone);
                if (!result.success) {
                    game.addLogEntry(`âŒ ${result.reason}`, 'system');
                }
            });
        });

        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('attack-btn').addEventListener('click', async () => {
            await game.executeAttack();
        });

        document.getElementById('new-turn-btn').addEventListener('click', () => {
            game.clearField();
            game.addLogEntry('ğŸ”„ æ–°å›åˆé–‹å§‹', 'system');
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            location.reload();
        });

        // å•Ÿå‹•éŠæˆ²
        game.startGame();
    </script>
</body>
</html>